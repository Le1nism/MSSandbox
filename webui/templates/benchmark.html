<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MSSandbox - Benchmark</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0e17; color: #e6e6f0; min-height: 100vh; padding: 20px; }
		.container { max-width: 1000px; margin: 0 auto; background: #12121a; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.4); overflow: hidden; }
		.header { background: #17172a; color: #e6e6f0; padding: 30px; text-align: center; }
		.header h1 { font-size: 2.2em; margin-bottom: 8px; }
		.header p { opacity: 0.9; }
		.navbar { display: flex; gap: 10px; justify-content: center; padding: 12px; background: #161622; border-bottom: 1px solid #252538; }
		.navbar a { color: #c8c8e0; text-decoration: none; padding: 8px 14px; border-radius: 8px; border: 1px solid transparent; }
		.navbar a.active { background: #6a61e0; border-color: #6a61e0; color: #fff; }
		.navbar a:hover { background: #1a1a2b; border-color: #2a2a3a; }

		.content { padding: 24px; }
		.card { background: #141424; border: 1px solid #23233a; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
		.card h3 { color: #d2d2e6; margin-bottom: 12px; }
		.row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
		.row .field label { display: block; margin-bottom: 6px; color: #c8c8e0; font-weight: 600; }
		.row .field input { width: 100%; padding: 10px; border: 1px solid #2a2a3a; border-radius: 8px; background: #0f0e17; color: #e6e6f0; }
		.actions { display: flex; gap: 12px; margin-top: 12px; }
		.btn { background: #5b51d8; color: #ffffff; border: 1px solid #6a61e0; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 0.95em; transition: background 0.2s ease, transform 0.1s ease; }
		.btn:hover { transform: translateY(-1px); background: #6a61e0; }
		.btn:disabled { background: #3a3956; cursor: not-allowed; }
		.btn-start { background: #2cce89; border-color: #2cce89; }
		.btn-stop { background: #e0526f; border-color: #e0526f; }
		.btn-view { background: #6a61e0; border-color: #6a61e0; }
		.status { margin-top: 10px; font-weight: 600; color: #b4b0ff; }
		.json-display { background: #151525; border: 1px solid #23233a; border-radius: 6px; padding: 14px; font-family: 'Courier New', monospace; white-space: pre-wrap; margin-top: 12px; }

		/* Cards grid for previous runs */
		.cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; margin-top: 12px; }
		.card-run { background: #16162a; border: 1px solid #23233a; border-radius: 10px; padding: 14px; }
		.card-run .header { display: flex; justify-content: space-between; align-items: center; background: transparent; padding: 0; }
		.card-run .title { color: #c8c8e0; font-weight: 700; font-size: 1.05em; }
		.card-run .sub { color: #8f8fb3; font-size: 0.85em; }
		.badge { padding: 3px 8px; border-radius: 999px; font-size: 0.75em; font-weight: 700; }
		.badge-ok { background: #142a20; color: #91ffb1; border: 1px solid #244b3f; }
		.badge-warn { background: #2a1620; color: #ff9aa2; border: 1px solid #4b2433; }
		.metrics-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
		.metric { background: #141424; border: 1px solid #23233a; border-radius: 8px; padding: 10px; }
		.metric .label { color: #8f8fb3; font-size: 0.8em; margin-bottom: 4px; }
		.metric .value { color: #e6e6f0; font-weight: 700; font-size: 1.05em; word-break: break-word; }
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>MSSandbox Benchmark</h1>
			<p>Push the system at full speed and measure throughput</p>
		</div>
		<div class="navbar">
			<a href="/automation">Automation</a>
			<a href="/benchmark" class="active">Benchmark</a>
		</div>
		<div class="content">
			<div class="card">
				<h3>Parameters</h3>
				<div class="row">
					<div class="field">
						<label for="bm-duration">Duration (s)</label>
						<input id="bm-duration" type="number" value="15" min="1" />
					</div>
					<div class="field">
						<label for="bm-workers">Workers</label>
						<input id="bm-workers" type="number" value="4" min="1" />
					</div>
				</div>
				<div class="row" style="margin-top: 10px;">
					<div class="field">
						<label for="bm-bytes">Payload size (bytes)</label>
						<input id="bm-bytes" type="number" value="512" min="0" step="1" />
					</div>
				</div>
				<div class="actions">
					<button class="btn btn-start" id="bm-start" onclick="startBenchmark()">Start Benchmark</button>
					<button class="btn btn-stop" id="bm-stop" onclick="stopBenchmark()" disabled>Stop</button>
					<button class="btn btn-view" onclick="loadBenchmarkLogs()">View Last Logs</button>
				</div>
				<div id="benchmark-status" class="status">Benchmark idle</div>
				<div class="json-display" id="benchmark-result" style="display:none;"></div>
			</div>

			<div class="card">
				<h3>Previous Runs</h3>
				<div class="actions">
					<button class="btn btn-view" onclick="loadBenchmarkLogs()">Refresh</button>
				</div>
				<div id="logs-cards" class="cards"></div>
			</div>
		</div>
	</div>

	<script>
		let benchmarkPolling = null;

		async function startBenchmark() {
			const duration = parseInt(document.getElementById('bm-duration').value || '15', 10);
			const workers = parseInt(document.getElementById('bm-workers').value || '4', 10);
			const bytes = parseInt(document.getElementById('bm-bytes').value || '0', 10);
			const startBtn = document.getElementById('bm-start');
			const stopBtn = document.getElementById('bm-stop');
			const statusDiv = document.getElementById('benchmark-status');
			const resultDiv = document.getElementById('benchmark-result');
			resultDiv.style.display = 'none';
			statusDiv.textContent = 'Starting benchmark...';
			startBtn.disabled = true;
			stopBtn.disabled = false;
			try {
				const resp = await fetch('/api/benchmark/start', {
					method: 'POST', headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ duration_seconds: duration, payload_bytes: bytes, workers })
				});
				const data = await resp.json();
				if (!resp.ok || data.error) throw new Error(data.error || 'Failed to start benchmark');
				statusDiv.textContent = 'Benchmark running...';
				if (benchmarkPolling) clearInterval(benchmarkPolling);
				benchmarkPolling = setInterval(pollBenchmarkStatus, 1000);
			} catch (e) {
				statusDiv.textContent = 'Error starting benchmark';
				startBtn.disabled = false; stopBtn.disabled = true;
			}
		}

		async function pollBenchmarkStatus() {
			const statusDiv = document.getElementById('benchmark-status');
			const resultDiv = document.getElementById('benchmark-result');
			try {
				const resp = await fetch('/api/benchmark/status');
				const data = await resp.json();
				if (data.error) throw new Error(data.error);
				const prod = data.producer || {};
				const running = !!(prod.running);
				const rps = prod.throughput && prod.throughput.requests_per_second ? prod.throughput.requests_per_second.toFixed(1) : 'n/a';
				const bps = prod.throughput && prod.throughput.bytes_per_second ? prod.throughput.bytes_per_second.toFixed(0) : 'n/a';
				statusDiv.textContent = `Running: ${running} | Producer succ=${prod.stats ? prod.stats.succeeded : 'n/a'} fail=${prod.stats ? prod.stats.failed : 'n/a'} | RPS=${rps} | B/s=${bps}`;
				if (!running) {
					clearInterval(benchmarkPolling); benchmarkPolling = null;
					try {
						const finalize = await fetch('/api/benchmark/stop', { method: 'POST' });
						const finalData = await finalize.json();
						resultDiv.style.display = 'block'; resultDiv.textContent = JSON.stringify(finalData, null, 2);
					} catch (_) {
						resultDiv.style.display = 'block'; resultDiv.textContent = JSON.stringify(data, null, 2);
					}
					document.getElementById('bm-start').disabled = false; document.getElementById('bm-stop').disabled = true;
				}
			} catch (_) { statusDiv.textContent = 'Error polling benchmark status'; }
		}

		async function stopBenchmark() {
			const startBtn = document.getElementById('bm-start');
			const stopBtn = document.getElementById('bm-stop');
			const statusDiv = document.getElementById('benchmark-status');
			const resultDiv = document.getElementById('benchmark-result');
			try {
				const resp = await fetch('/api/benchmark/stop', { method: 'POST' });
				const data = await resp.json();
				statusDiv.textContent = 'Benchmark stopped';
				resultDiv.style.display = 'block'; resultDiv.textContent = JSON.stringify(data, null, 2);
			} catch (_) { statusDiv.textContent = 'Stop failed'; }
			finally { if (benchmarkPolling) clearInterval(benchmarkPolling); benchmarkPolling = null; startBtn.disabled = false; stopBtn.disabled = true; }
		}

		async function loadBenchmarkLogs() {
			const resultDiv = document.getElementById('benchmark-result');
			const cards = document.getElementById('logs-cards');
			try {
				const resp = await fetch('/api/benchmark/logs?n=12');
				const data = await resp.json();
				const logs = Array.isArray(data.logs) ? data.logs : [];
				cards.innerHTML = renderLogCards(logs);
				// Optionally keep raw JSON collapsed
				resultDiv.style.display = 'none';
			} catch (e) {
				cards.innerHTML = '<div class="card-run"><div class="sub">Failed to load logs</div></div>';
			}
		}

		function renderLogCards(logs) {
			if (!logs || logs.length === 0) {
				return '<div class="card-run"><div class="sub">No logs yet</div></div>';
			}
			return logs.map((log, idx) => {
				const t = log.timestamp || '';
				const prod = log.producer || {};
				const cons = log.consumer || {};
				const cfg = prod.config || {};
				const stats = prod.stats || {};
				const thr = prod.throughput || {};
				const ok = (stats.failed || 0) === 0;
				const rps = isFiniteNum(thr.requests_per_second) ? thr.requests_per_second.toFixed(1) : 'n/a';
				const bps = isFiniteNum(thr.bytes_per_second) ? formatBytes(thr.bytes_per_second) + '/s' : 'n/a';
				const sz = cfg.payload_bytes ? formatBytes(cfg.payload_bytes) : 'default';
				const elapsed = isFiniteNum(prod.elapsed_seconds) ? prod.elapsed_seconds.toFixed(1) + 's' : '—';
				const consCount = (typeof cons.processed_count === 'number') ? cons.processed_count : 'n/a';
				const consBytes = (typeof cons.bytes_received === 'number') ? formatBytes(cons.bytes_received) : 'n/a';
				return `
					<div class="card-run">
						<div class="header">
							<div>
								<div class="title">Run ${logs.length - idx}</div>
								<div class="sub">${escapeHtml(t)}</div>
							</div>
							<span class="badge ${ok ? 'badge-ok' : 'badge-warn'}">${ok ? 'OK' : 'WARN'}</span>
						</div>

						<div class="metrics-row">
							<div class="metric"><div class="label">Duration</div><div class="value">${elapsed}</div></div>
							<div class="metric"><div class="label">Workers</div><div class="value">${cfg.workers || '1'}</div></div>
							<div class="metric"><div class="label">Payload</div><div class="value">${sz}</div></div>
							<div class="metric"><div class="label">Succeeded / Failed</div><div class="value">${stats.succeeded || 0} / ${stats.failed || 0}</div></div>
							<div class="metric"><div class="label">Throughput</div><div class="value">${rps} rps</div></div>
							<div class="metric"><div class="label">Bandwidth</div><div class="value">${bps}</div></div>
							<div class="metric"><div class="label">Consumer processed</div><div class="value">${consCount}</div></div>
							<div class="metric"><div class="label">Consumer bytes</div><div class="value">${consBytes}</div></div>
						</div>
					</div>
				`;
			}).join('');
		}

		function isFiniteNum(n) { return typeof n === 'number' && isFinite(n); }
		function formatBytes(num) {
			try {
				const units = ['B','KB','MB','GB','TB'];
				let n = Number(num);
				if (!isFinite(n) || n < 0) return '0 B';
				let i = 0; while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
				return `${n.toFixed(n >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
			} catch (_) { return String(num); }
		}
		function escapeHtml(s) {
			return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
		}
	</script>
</body>
</html>


